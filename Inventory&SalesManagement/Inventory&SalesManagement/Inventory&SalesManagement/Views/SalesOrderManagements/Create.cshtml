@model Inventory_SalesManagement.Models.Entities.SalesOrder

@{
    ViewData["Title"] = "New Sales Order";
    // Serialize data so JavaScript can read Stock levels
    var productsJson = System.Text.Json.JsonSerializer.Serialize(ViewBag.ProductList);
}

<div class="container d-flex justify-content-center" style="min-height: 80vh;">
    <div class="col-lg-10">
        <div class="card-modern mt-5">
            <div class="card-header-modern bg-white border-0 pt-4 pb-0 d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="fw-bold text-primary mb-0">New Sale</h3>
                    <p class="text-muted small">Stock levels update automatically after saving</p>
                </div>
                <div class="text-end">
                    <h5 class="fw-bold text-success mb-0" id="grandTotalDisplay">$0.00</h5>
                    <small class="text-muted">Total Amount</small>
                </div>
            </div>

            <div class="card-body p-4">

                <div class="mb-4 p-3 bg-light rounded border border-primary border-opacity-25">
                    <label class="fw-bold text-primary mb-2"><i class="fa-solid fa-barcode me-2"></i>Scan Product Here</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="fa-solid fa-magnifying-glass"></i></span>
                        <input type="text" id="barcodeInput" class="form-control form-control-lg" placeholder="Scan barcode or type code and hit Enter..." autofocus />
                    </div>
                </div>

                <form asp-action="Create" id="salesForm">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <div class="table-responsive mb-4">
                        <table class="table table-modern align-middle" id="itemsTable">
                            <thead>
                                <tr>
                                    <th style="width: 35%">Product</th>
                                    <th style="width: 15%">Price</th>
                                    <th style="width: 15%">Stock Left</th>
                                    <th style="width: 15%">Quantity</th>
                                    <th style="width: 15%">Subtotal</th>
                                    <th style="width: 5%"></th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-primary" onclick="addItemRow()">
                            <i class="fa-solid fa-plus me-2"></i>Add Product
                        </button>

                        <div>
                            <a asp-action="Index" class="btn btn-light text-muted me-2">Cancel</a>
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fa-solid fa-check me-2"></i>Confirm Sale
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 1. Load Data
        var productData = @Html.Raw(productsJson);
        var rowIndex = 0;

        // --- BARCODE SCANNER LOGIC ---
        document.getElementById('barcodeInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                var code = this.value.trim();
                if(code) {
                    findAndAddProduct(code);
                }
                this.value = '';
            }
        });

        function findAndAddProduct(barcode) {
            var product = productData.find(p => p.Barcode === barcode);
            if (product) {
                if (product.StockQuantity < 1) {
                    alert("Item Found: " + product.Name + "\nBUT it is Out of Stock!");
                    return;
                }
                addItemRow(product.Id);
            } else {
                alert("Product with barcode '" + barcode + "' not found.");
            }
        }
        // -----------------------------

        function addItemRow(preSelectedId = null) {
            var tableBody = document.querySelector('#itemsTable tbody');
            var tr = document.createElement('tr');

            // Build the Dropdown Options
            var options = `<option value="">-- Select --</option>`;
            productData.forEach(p => {
                let disabled = p.StockQuantity < 1 ? 'disabled' : '';
                let label = p.Name;
                let selected = (preSelectedId && p.Id == preSelectedId) ? 'selected' : '';

                // IMPORTANT: We attach 'data-stock' here so we can read it later
                options += `<option value="${p.Id}" data-price="${p.Price}" data-stock="${p.StockQuantity}" ${disabled} ${selected}>${label}</option>`;
            });

            tr.innerHTML = `
                <td>
                    <select name="Items[${rowIndex}].ProductId" class="form-select product-select" onchange="updateRow(this)" required>
                        ${options}
                    </select>
                </td>
                <td><input type="text" class="form-control-plaintext price-display" value="$0.00" readonly /></td>

                <td>
                    <span class="badge bg-light text-dark border stock-display">-</span>
                </td>

                <td>
                    <input type="number" name="Items[${rowIndex}].Quantity" class="form-control qty-input" min="1" value="1" onchange="updateRow(this)" required />
                    <small class="text-danger stock-warning d-none" style="font-size:0.7rem; display:block;">Not enough stock!</small>
                </td>
                <td><span class="fw-bold subtotal-display">$0.00</span></td>
                <td><button type="button" class="btn btn-sm text-danger" onclick="removeRow(this)"><i class="fa-solid fa-trash"></i></button></td>
            `;

            tableBody.appendChild(tr);

            // If added via scanner, force update immediately
            if (preSelectedId) {
                var newSelect = tr.querySelector('.product-select');
                updateRow(newSelect);
            }

            rowIndex++;
        }

        // --- THIS IS THE KEY FUNCTION ---
        function updateRow(element) {
            // 1. Find the parent row of whatever element triggered this (select or input)
            var row = element.closest('tr');

            // 2. Grab all the specific elements INSIDE this row
            var select = row.querySelector('.product-select');
            var qtyInput = row.querySelector('.qty-input');
            var priceDisplay = row.querySelector('.price-display');
            var stockDisplay = row.querySelector('.stock-display');
            var subtotalDisplay = row.querySelector('.subtotal-display');
            var warningMsg = row.querySelector('.stock-warning');

            var price = 0;
            var maxStock = 0;

            // 3. Check which option is CURRENTLY selected
            if (select.selectedIndex > 0) {
                var selectedOption = select.options[select.selectedIndex];

                // Read the data attributes from the selected option
                price = parseFloat(selectedOption.getAttribute('data-price'));
                maxStock = parseInt(selectedOption.getAttribute('data-stock'));

                // 4. Update the Stock Badge UI
                if (maxStock < 5) {
                    stockDisplay.className = "badge bg-danger text-white stock-display";
                    stockDisplay.innerText = maxStock + " Left!";
                } else {
                    stockDisplay.className = "badge bg-success bg-opacity-10 text-success border border-success stock-display";
                    stockDisplay.innerText = maxStock + " Available";
                }
            } else {
                // Reset if nothing selected
                stockDisplay.innerText = "-";
                stockDisplay.className = "badge bg-light text-dark border stock-display";
            }

            // 5. Calculate Math
            var qty = parseInt(qtyInput.value) || 0;
            var subtotal = price * qty;

            // 6. Validation: Is Qty > Stock?
            if (maxStock > 0 && qty > maxStock) {
                qtyInput.classList.add('is-invalid');
                warningMsg.classList.remove('d-none'); // Show warning
            } else {
                qtyInput.classList.remove('is-invalid');
                warningMsg.classList.add('d-none'); // Hide warning
            }

            // 7. Update Text
            priceDisplay.value = "$" + price.toFixed(2);
            subtotalDisplay.innerText = "$" + subtotal.toFixed(2);

            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            var total = 0;
            document.querySelectorAll('.product-select').forEach(select => {
                var row = select.closest('tr');
                var price = parseFloat(select.options[select.selectedIndex]?.getAttribute('data-price') || 0);
                var qty = parseInt(row.querySelector('.qty-input').value) || 0;
                total += price * qty;
            });
            document.getElementById('grandTotalDisplay').innerText = "$" + total.toFixed(2);
        }

        function removeRow(btn) {
            btn.closest('tr').remove();
            calculateGrandTotal();
        }

        // Initialize with one empty row
        document.addEventListener('DOMContentLoaded', function() {
            
        });
    </script>
}